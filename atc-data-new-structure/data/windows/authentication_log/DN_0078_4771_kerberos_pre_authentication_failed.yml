title: Kerberos pre-authentication failed
description: >
  This event generates every time the Key Distribution Center fails 
  to issue a Kerberos Ticket Granting Ticket (TGT). This can occur 
  when a domain controller doesn’t have a certificate installed for 
  smart card authentication (for example, with a "Domain Controller" 
  or "Domain Controller Authentication" template), the user’s password 
  has expired, or the wrong password was provided. This event 
  generates only on domain controllers
event_id: 4771
attack_data_source: logon session
attack_data_component: logon session creation
platform: windows
provider: Microsoft-Windows-Security-Auditing
channel: Security
atc_id: DN0078
loggingpolicy:
  - LP0038: Failure
contributors:
  - '@atc_project'
references:
  - text: 'Microsoft Docs: event-4771.md'
    link: 'https://github.com/MicrosoftDocs/windows-itpro-docs/blob/public/windows/security/threat-protection/auditing/event-4771.md'
  - text: 'OSSEM DD: event-4771.yml'
    link: 'https://github.com/OTRF/OSSEM/blob/master/source/data_dictionaries/windows/etw-providers/Microsoft-Windows-Security-Auditing/events/event-4771.yml'
fields:

  - original_name: TargetUserName
    description: >
      the name of account, for which (TGT) ticket was requested. Computer
      account name ends with $ character.
    sample_value: dadmin
    elastic_ecs_name: related.user
    splunk_cim_name: N/A
    otr_ossem_name: user_name

  - original_name: TargetSid
    description: >
      'SID of account object for which (TGT) ticket was requested. Event
      Viewer automatically tries to resolve SIDs and show the account name. If the SID
      cannot be resolved, you will see the source data in the event. For example: CONTOSO\dadmin
      or CONTOSO\WIN81$.'
    sample_value: S-1-5-21-3457937927-2839227994-823803824-1104
    elastic_ecs_name: winlog.computerObject.id
    splunk_cim_name: N/A
    otr_ossem_name: user_sid

  - original_name: ServiceName
    description: >
      'the name of the service in the Kerberos Realm to which TGT request
      was sent. Typically has one of the following formats: krbtgt/DOMAIN_NETBIOS_NAME.
      Example: krbtgt/CONTOSO, krbtgt/DOMAIN_FULL_NAME. Example: krbtgt/CONTOSO.LOCAL'
    sample_value: krbtgt/CONTOSO.LOCAL
    elastic_ecs_name: service.name
    splunk_cim_name: N/A
    otr_ossem_name: service_name

  - original_name: TicketOptions
    description: this is a set of different Ticket Flags in hexadecimal format
    sample_value: '0x40810010'
    elastic_ecs_name: winlog.event_data.TicketOptions
    splunk_cim_name: N/A
    otr_ossem_name: ticket_options

  - original_name: Status
    description: hexadecimal failure code of failed TGT issue operation
    sample_value: '0x10'
    elastic_ecs_name: winlog.event_data.Status
    splunk_cim_name: N/A
    otr_ossem_name: ticket_status

  - original_name: PreAuthType
    description: the code of pre-Authentication type which was used in TGT request.
    sample_value: '15'
    elastic_ecs_name: winlog.event_data.PreAuthType
    splunk_cim_name: N/A
    otr_ossem_name: ticket_pre_auth_type

  - original_name: IpAddress
    description: IP address of the computer from which the TGT request was received.
    sample_value: ::ffff:10.0.0.12
    elastic_ecs_name: source.ip
    splunk_cim_name: src_ip
    otr_ossem_name: src_ip_addr

  - original_name: IpPort
    description: source port number of client network connection (TGT request connection).
    sample_value: '49254'
    elastic_ecs_name: source.port
    splunk_cim_name: src_port
    otr_ossem_name: src_port

  - original_name: CertIssuerName
    description: the name of the Certification Authority that issued the smart card
      certificate. Populated in Issued by field in certificate.
    sample_value: ''
    elastic_ecs_name: winlog.event_data.CertIssuerName
    splunk_cim_name: N/A
    otr_ossem_name: certificate_issuer

  - original_name: CertSerialNumber
    description: smart card certificate's serial number. Can be found in Serial number
      field in the certificate.
    sample_value: ''
    elastic_ecs_name: winlog.event_data.CertSerialNumber
    splunk_cim_name: N/A
    otr_ossem_name: certificate_serial_number

  - original_name: CertThumbprint
    description: smart card certificate's thumbprint. Can be found in Thumbprint field
      in the certificate.
    sample_value: ''
    elastic_ecs_name: winlog.event_data.CertThumbprint
    splunk_cim_name: N/A
    otr_ossem_name: certificate_hash_sha1

sample: |
  - <Event xmlns="http://schemas.microsoft.com/win/2004/08/events/event">
    - <System>
      <Provider Name="Microsoft-Windows-Security-Auditing" Guid="{54849625-5478-4994-A5BA-3E3B0328C30D}" /> 
      <EventID>4771</EventID> 
      <Version>0</Version> 
      <Level>0</Level> 
      <Task>14339</Task> 
      <Opcode>0</Opcode> 
      <Keywords>0x8010000000000000</Keywords> 
      <TimeCreated SystemTime="2015-08-07T18:10:21.495462300Z" /> 
      <EventRecordID>166708</EventRecordID> 
      <Correlation /> 
      <Execution ProcessID="520" ThreadID="1084" /> 
      <Channel>Security</Channel> 
      <Computer>DC01.contoso.local</Computer> 
      <Security /> 
    </System>
    - <EventData>
      <Data Name="TargetUserName">dadmin</Data> 
      <Data Name="TargetSid">S-1-5-21-3457937927-2839227994-823803824-1104</Data> 
      <Data Name="ServiceName">krbtgt/CONTOSO.LOCAL</Data> 
      <Data Name="TicketOptions">0x40810010</Data> 
      <Data Name="Status">0x10</Data> 
      <Data Name="PreAuthType">15</Data> 
      <Data Name="IpAddress">::ffff:10.0.0.12</Data> 
      <Data Name="IpPort">49254</Data> 
      <Data Name="CertIssuerName" /> 
      <Data Name="CertSerialNumber" /> 
      <Data Name="CertThumbprint" /> 
    </EventData>
  </Event>
