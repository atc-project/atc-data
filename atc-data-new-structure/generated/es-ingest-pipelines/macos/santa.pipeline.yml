description: Pipeline for parsing Google Santa logs.
processors:
- set:
    field: event.ingested
    value: "{{_ingest.timestamp}}"
- grok:
    field: message
    patterns:
    - '\[%{TIMESTAMP_ISO8601:process.start}\] %{NOT_SEPARATOR} santad: action=%{NOT_SEPARATOR:santa.action}\|decision=%{NOT_SEPARATOR:santa.decision}\|reason=%{NOT_SEPARATOR:santa.reason}(\|explain=%{NOT_SEPARATOR:santa.explain})?\|sha256=%{NOT_SEPARATOR:process.hash.sha256}(\|cert_sha256=%{NOT_SEPARATOR:file.x509.issuer.certificate.leaf.hash.sha256})?(\|cert_cn=%{NOT_SEPARATOR:file.x509.issuer.common_name})?\|pid=%{NUMBER:process.pid}\|ppid=%{NUMBER:process.ppid}\|uid=%{NUMBER:user.id}\|user=%{NOT_SEPARATOR:user.name}\|gid=%{NUMBER:group.id}\|group=%{NOT_SEPARATOR:group.name}\|mode=%{WORD:santa.mode}\|path=%{NOT_SEPARATOR:process.executable}(\|args=%{NOT_SEPARATOR:process.args})?'
    - '\[%{TIMESTAMP_ISO8601:timestamp}\] %{NOT_SEPARATOR} santad: action=%{NOT_SEPARATOR:santa.action}\|mount=(%{NOT_SEPARATOR:santa.disk.mount})?\|volume=%{NOT_SEPARATOR:santa.disk.volume}\|bsdname=(%{NOT_SEPARATOR:santa.disk.bsdname})?(\|fs=%{NOT_SEPARATOR:santa.disk.fs})?(\|model=(%{NOT_SEPARATOR:santa.disk.model})?)?(\|serial=(%{NOT_SEPARATOR:santa.disk.serial})?)?(\|bus=(%{NOT_SEPARATOR:santa.disk.bus})?)?(\|dmgpath=(%{NOT_SEPARATOR:santa.disk.dmgpath})?)?(\|appearance=%{GREEDYDATA:event.start})?'
    pattern_definitions:
      NOT_SEPARATOR: "[^\\|]+"
    on_failure:
    - set:
        field: grok.error.message
        value: "{{ _ingest.on_failure_message }}"
- date:
    field: process.start
    target_field: process.start
    formats:
    - ISO8601
    ignore_failure: true
- set:
    field: "@timestamp"
    value: "{{ process.start }}"
    ignore_failure: true
- date:
    field: timestamp
    target_field: "@timestamp"
    formats:
    - ISO8601
    ignore_failure: true
- remove:
    field:
    - timestamp
    ignore_missing: true
- remove:
    if: "!ctx.containsKey('grok.error.message')"
    field:
    - message
    ignore_missing: true
- rename:
    field: message
    target_field: log.original
    ignore_missing: true
- remove:
    field:
    - log_level
    - tag
    ignore_missing: true
- rename:
    field: source_host
    target_field: host.name
    ignore_missing: true
on_failure:
- set:
    field: error.message
    value: "{{ _ingest.on_failure_message }}"